name: 1. Deploy to GCP VM (Automated CI/CD)

on:
  push:
    branches:
      - main
  workflow_dispatch: # Allows manual trigger from GitHub UI

jobs:
  deploy-vm:
    runs-on: ubuntu-latest
    
    # Environment variables based on your secrets (VM_HOST, VM_USER) and paths
    env:
      VM_HOST: ${{ secrets.VM_HOST }}        
      VM_USER: ${{ secrets.VM_USER }}        
      JAR_DEST_PATH: /opt/task_api/          
      FRONTEND_DEST_PATH: /var/www/task-frontend/ 

    steps:
    - uses: actions/checkout@v4

    # 1. Build Backend (Spring Boot)
    - name: Set up Java 17
      uses: actions/setup-java@v4
      with:
        java-version: '17'
        distribution: 'temurin'
    - name: Build Spring Boot JAR
      # Runs Maven from the correct nested directory, skipping tests
      run: mvn clean install -DskipTests
      working-directory: ./task_api/task_api 
    - name: Define JAR filename
      id: jar_name
      # Sets an output variable pointing to the built JAR file path
      run: echo "JAR_FILE=task_api/task_api/target/task_api-0.0.1-SNAPSHOT.jar" >> $GITHUB_OUTPUT
      
    # 2. Build Frontend (React)
    - name: Set up Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'

    # >>> CRITICAL FIX FOR STALE CODE/CSS <<<
    - name: Clean Frontend Directories
      # Removes all cache and previous build folders to guarantee a fresh copy
      run: rm -rf node_modules package-lock.json build
      working-directory: ./task-frontend
      
    - name: Install and Build React App
      # Runs npm build to generate the /build folder with the corrected relative API path
      run: |
        npm install
        npm run build
      working-directory: ./task-frontend

    # 3. Deployment (Copy Files via appleboy/scp-action)
    - name: Copy Backend JAR to VM
      uses: appleboy/scp-action@v0.1.7
      with:
        host: ${{ env.VM_HOST }}
        username: ${{ env.VM_USER }}
        key: ${{ secrets.SSH_PRIVATE_KEY }} # Authenticates using the private key secret
        source: ${{ steps.jar_name.outputs.JAR_FILE }}
        target: ${{ env.JAR_DEST_PATH }}
        
    - name: Copy Frontend Build to VM
      uses: appleboy/scp-action@v0.1.7
      with:
        host: ${{ env.VM_HOST }}
        username: ${{ env.VM_USER }}
        key: ${{ secrets.SSH_PRIVATE_KEY }} # Authenticates using the private key secret
        # Note: We copy the contents (*), not the folder itself, to put files directly into /var/www/task-frontend/
        source: ./task-frontend/build/*
        target: ${{ env.FRONTEND_DEST_PATH }}
        
    # 4. Execute Remote Deployment Script and Restart Services
    - name: Run Deploy Script on VM
      uses: appleboy/ssh-action@v1.0.3
      with:
        host: ${{ env.VM_HOST }}
        username: ${{ env.VM_USER }}
        key: ${{ secrets.SSH_PRIVATE_KEY }} # Authenticates using the private key secret
        script: |
          # 1. Runs the comprehensive script to restart services
          /opt/deploy.sh 
          
          # 2. Manual Nginx restart to ensure cache is cleared and new files are served
          sudo systemctl restart nginx
          
          # 3. Final status checks
          sudo systemctl status task-api --no-pager
          sudo systemctl status nginx --no-pager
