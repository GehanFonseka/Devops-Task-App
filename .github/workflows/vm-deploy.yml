name: 1. Deploy to GCP VM (Automated CI/CD)

on:
  push:
    branches:
      - main
  workflow_dispatch: # Allows manual trigger from GitHub UI

jobs:
  deploy-vm:
    runs-on: ubuntu-latest
    
    # Environment variables based on your secrets (VM_HOST, VM_USER) and paths
    env:
      VM_HOST: ${{ secrets.VM_HOST }}        
      VM_USER: ${{ secrets.VM_USER }}        
      JAR_DEST_DIR: /opt/task_api/          
      FRONTEND_DEST_DIR: /var/www/task-frontend/ 

    steps:
    - uses: actions/checkout@v4

    # 1. Build Backend (Spring Boot)
    - name: Set up Java 17
      uses: actions/setup-java@v4
      with:
        java-version: '17'
        distribution: 'temurin'
    - name: Build Spring Boot JAR
      run: mvn clean install -DskipTests
      working-directory: ./task_api/task_api 
    - name: Define JAR filename
      id: jar_name
      run: echo "JAR_FILE=task_api/task_api/target/task_api-0.0.1-SNAPSHOT.jar" >> $GITHUB_OUTPUT
      
    # 2. Build Frontend (React)
    - name: Set up Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'

    - name: Clean Frontend Directories (CRITICAL FIX)
      # Ensures all old build artifacts and node modules are removed for a fresh build
      run: rm -rf node_modules package-lock.json build
      working-directory: ./task-frontend
      
    - name: Install and Build React App
      run: |
        npm install
        npm run build
      working-directory: ./task-frontend

    # 3. Remote Setup (Ensure Directories are Ready and Cleaned)
    - name: Setup Remote Directories and Clean Frontend
      uses: appleboy/ssh-action@v1.0.3
      with:
        host: ${{ env.VM_HOST }}
        username: ${{ env.VM_USER }}
        key: ${{ secrets.SSH_PRIVATE_KEY }}
        script: |
          # Create backend and frontend directories
          sudo mkdir -p ${{ env.JAR_DEST_DIR }}
          sudo mkdir -p ${{ env.FRONTEND_DEST_DIR }}
          
          # CRITICAL FIX: Use $VM_USER shell variable for chown command
          # Set ownership for the copy steps
          sudo chown -R www-data:www-data ${{ env.FRONTEND_DEST_DIR }}
          
          # Keep backend directory owned by SSH user (now using $VM_USER)
          sudo chown -R $VM_USER:$VM_USER ${{ env.JAR_DEST_DIR }}
          
          # Force clean the frontend directory to avoid old file conflicts
          sudo rm -rf ${{ env.FRONTEND_DEST_DIR }}/*

    # 4. Deployment (Copy Files into the now-empty directories)
    - name: Copy Backend JAR to VM
      uses: appleboy/scp-action@v0.1.7
      with:
        host: ${{ env.VM_HOST }}
        username: ${{ env.VM_USER }}
        key: ${{ secrets.SSH_PRIVATE_KEY }}
        source: ${{ steps.jar_name.outputs.JAR_FILE }}
        target: ${{ env.JAR_DEST_DIR }}
        
    - name: Copy Frontend Build to VM
      uses: appleboy/scp-action@v0.1.7
      with:
        host: ${{ env.VM_HOST }}
        username: ${{ env.VM_USER }}
        key: ${{ secrets.SSH_PRIVATE_KEY }}
        source: ./task-frontend/build/*
        target: ${{ env.FRONTEND_DEST_DIR }}
        
    # 5. Execute Remote Deployment Script and Restart Services
    - name: Run Deploy Script on VM
      uses: appleboy/ssh-action@v1.0.3
      with:
        host: ${{ env.VM_HOST }}
        username: ${{ env.VM_USER }}
        key: ${{ secrets.SSH_PRIVATE_KEY }}
        script: |
          # The service restart logic is contained in the remote script
          /opt/deploy.sh
          
          # Final status checks
          sudo systemctl status task-api --no-pager
          sudo systemctl status nginx --no-pager
