name: Deploy to Google Cloud VM

on:
  push:
    branches:
      - main

env:
  VM_HOST: ${{ secrets.VM_HOST }}
  VM_USER: ${{ secrets.VM_USER }}
  SSH_KEY: ${{ secrets.SSH_PRIVATE_KEY }}

  # Backend
  BACKEND_DIR: backend
  JAR_NAME: task-lister.jar
  JAR_DEST_DIR: /var/www/task-backend/

  # Frontend
  FRONTEND_DIR: frontend
  FRONTEND_BUILD_DIR: frontend/build
  FRONTEND_DEST_DIR: /var/www/task-frontend/

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      # 1Ô∏è‚É£ Checkout Code
      - name: Checkout Repository
        uses: actions/checkout@v4

      # 2Ô∏è‚É£ Set up Java for Backend
      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: 17

      # 3Ô∏è‚É£ Build Spring Boot Backend
      - name: Build Backend
        run: |
          cd $BACKEND_DIR
          chmod +x mvnw
          ./mvnw clean package -DskipTests
          cp target/*.jar ../$JAR_NAME

      # 4Ô∏è‚É£ Set up Node.js for Frontend
      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20

      # 5Ô∏è‚É£ Build React Frontend
      - name: Build Frontend
        run: |
          cd $FRONTEND_DIR
          npm ci
          npm run build

      # 6Ô∏è‚É£ Prepare VM Directories with Correct Permissions
      - name: Setup Remote Directories and Grant Write Access
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ env.VM_HOST }}
          username: ${{ env.VM_USER }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          script: |
            echo "Setting up backend and frontend directories..."
            sudo mkdir -p ${{ env.JAR_DEST_DIR }}
            sudo mkdir -p ${{ env.FRONTEND_DEST_DIR }}

            # ‚úÖ Permission fix
            sudo chmod -R 777 ${{ env.FRONTEND_DEST_DIR }}
            sudo chmod -R 777 ${{ env.JAR_DEST_DIR }}

            sudo rm -rf ${{ env.FRONTEND_DEST_DIR }}/*

      # 7Ô∏è‚É£ Copy Backend Jar to VM
      - name: Copy Backend JAR
        uses: appleboy/scp-action@v0.1.7
        with:
          host: ${{ env.VM_HOST }}
          username: ${{ env.VM_USER }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          source: ${{ env.JAR_NAME }}
          target: ${{ env.JAR_DEST_DIR }}

      # 8Ô∏è‚É£ Restart Backend Service (Spring Boot)
      - name: Restart Backend Service
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ env.VM_HOST }}
          username: ${{ env.VM_USER }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          script: |
            echo "Restarting backend service..."
            sudo pkill -f ${{ env.JAR_NAME }} || true
            nohup java -jar ${{ env.JAR_DEST_DIR }}${{ env.JAR_NAME }} > /dev/null 2>&1 &

      # 9Ô∏è‚É£ Copy React Build to VM
      - name: Deploy Frontend to VM
        uses: appleboy/scp-action@v0.1.7
        with:
          host: ${{ env.VM_HOST }}
          username: ${{ env.VM_USER }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          source: ${{ env.FRONTEND_BUILD_DIR }}/*
          target: ${{ env.FRONTEND_DEST_DIR }}

      # üîü Restart Nginx (if used)
      - name: Restart Nginx
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ env.VM_HOST }}
          username: ${{ env.VM_USER }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          script: |
            echo "Restarting Nginx..."
            sudo systemctl restart nginx || true
