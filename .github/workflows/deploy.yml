name: Deploy to Docker Hub

on:
  push:
    branches:
      - main

jobs:
  docker:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v3

    - name: Log in to Docker Hub
      uses: docker/login-action@v2
      with:
        username: ${{ secrets.DOCKER_USERNAME }}
        password: ${{ secrets.DOCKER_PASSWORD }}

    - name: Build backend image
      run: |
        docker build -t gehanfonseka/devops-task-backend:latest ./task_api

    - name: Build frontend image
      run: |
        docker build -t gehanfonseka/devops-task-frontend:latest ./task-frontend

    - name: Push backend image
      run: docker push gehanfonseka/devops-task-backend:latest

    - name: Push frontend image
      run: docker push gehanfonseka/devops-task-frontend:latest

  deploy:
    needs: docker
    runs-on: ubuntu-latest
    steps:
      - name: Set up SSH
        uses: webfactory/ssh-agent@v0.9.0
        with:
          ssh-private-key: ${{ secrets.VM_SSH_KEY }}

      - name: Add VM to known hosts
        run: |
          mkdir -p ~/.ssh
          ssh-keyscan -H 35.226.182.20 >> ~/.ssh/known_hosts

      - name: Deploy via SSH (pull images and restart)
        run: |
          ssh gehan@35.226.182.20 << 'ENDSSH'
            set -e
            cd /var/www/task-app/Devops-Task-App
            echo "Repository status:" && git rev-parse --short HEAD || true

            echo "Stopping containers..."
            docker-compose down || true

            echo "Pulling latest images..."
            docker-compose pull

            echo "Starting containers..."
            docker-compose up -d

            echo "Container status:"
            docker-compose ps
          ENDSSH
